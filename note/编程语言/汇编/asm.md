---
title: "asm"
date: "2017-06-30 16:22"
---

# 汇编笔记
采用汇编写程序时，如在Linux系统下，采用gcc直接编译链接，生成的是Linux系统下可执行的应用程序，因为gcc在链接时采用了gcc默认的链接脚本(.lds)。而对于需要编译成Linux kernel、uboot、单片机裸机程序等，需要明确指出程序的入口地址等，需要为gcc链接器指明你的链接脚本。以下是对于编译为裸机等方面的笔记记录。
## 代码链接中的段

链接时，代码默认包含三段进行链接(用户可以自定义段)：数据段，代码段，BSS段。
1. 数据段(data)
  - 初始化的全局变量存放在data段

2. 代码段(text)
  - 代码段存放代码
3. BSS段
  -  未初始化的全局变量存放在BSS段

## 堆栈
1. 局部变量存放在栈
2. malloc 出的变量存放在堆

## 汇编编译链接
### 汇编编译不链接
   ***arm-linux-gnueabihf-gcc -c file.S -o outputname***  
   -c 表示只编译，不链接
### 汇编文件链接
   ***arm-linux-gnueabihf-ld -nostadlib -T ld.lds file.o***  
   - -T 为指定链接脚本 如果不指定，则采用gcc默认的链接脚本进行链接
   - -nostdlib 表示不链接系统的运行库(从最顶层构建自己程序，不链接系统库，而是从lds文件指定的ENtry为入口)
   - 链接生成代码文件，可使用 ***arm-linux-gnueabihf-objdump -h/-f out.bin*** 进行其链接形式的查看。

## 汇编程序入口
汇编程序的入口由lds文件中的 **ENTRY()** 进行标识(代码中至少有一个ENTRY)。如stm32 gcc编译平台的链接文件：  
> ENTRY(Reset_Handler) 表明 Reset_Handler 标号出为程序的入口

## 从汇编进入C的准备
1. 由于C代码依赖于堆栈，因此，从汇编进入C代码前，汇编代码需要完成SP指针的赋值，标明堆栈位置。
2. C语言全局变量如果未初始化，则默认为0。由于未初始化的全局变量存放在BSS段中，因此，汇编中应清BSS段(将BSS段全置为0)。
3. 完成上述两步之后，方可调用C代码。
